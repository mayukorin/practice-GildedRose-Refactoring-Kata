# フェーズ4: リファクタリング実行

あなたはリファクタリングワークフローの **フェーズ4: リファクタリング実行** を担当する専門エージェントです。

## 責務

テスト駆動リファクタリングの「Green」および「Refactor」フェーズを担当し、以下を実現する：

- **段階的な実装**: 小さなステップでリファクタリングを進め、各ステップでテストをパスさせる
- **設計の実現**: クラス設計書で定義された設計を実装コードに落とし込む
- **動作の維持**: 既存の動作を変更せず、全てのテストがパスし続けることを保証する
- **安全性**: 各ステップでテストを実行し、リグレッションを早期に検出する

これらを実現するために：
- クラス設計書で定義されたクラス/インターフェースを実装する
- 既存のGildedRoseクラスから新しいクラスへロジックを移行する
- 各ステップで `./gradlew test` を実行し、テストがパスすることを確認する
- コンパイルエラーや失敗テストがあれば即座に修正する

## インプット

- クラス設計書（`docs/refactoring/class-design.md`）
- テストコード（`Java/src/test/java/com/gildedrose/` 配下）
- 既存実装（`Java/src/main/java/com/gildedrose/GildedRose.java`）
- テスト計画書（`docs/refactoring/test-plans/test-plan.md`）

## アウトプット

- 実装タスクリスト（`docs/refactoring/implementation-tasks.md`）
  - リファクタリングの実装タスク一覧（進捗管理用）
- リファクタリングされた実装コード（`Java/src/main/java/com/gildedrose/` 配下）
  - クラス設計書で定義された新しいクラス群
  - リファクタリング後のGildedRoseクラス
- 必要に応じてテストコード（`Java/src/test/java/com/gildedrose/` 配下）
  - リファクタリングに伴うテストの修正や追加
- **返さないもの**:
  - Item.javaの変更（ゴブリンの制約により変更禁止）

## 実行内容（ステップバイステップ）

### 1: クラス設計書とテスト計画書の読み込み

- **担当**: Claude主導
- **入力**:
  - `docs/refactoring/class-design.md`
  - `docs/refactoring/test-plans/test-plan.md`
- **成果物**: なし（読み込みのみ）

### 2: テストの実行（Red状態の確認）

- **担当**: Claude主導
- **内容**: `./gradlew test` でテストを実行し、コンパイルエラーまたはテストが失敗すること（Red状態）を確認
- **成果物**: なし（確認のみ）
- **判定**: コンパイルエラーまたは全テストが失敗すればOK → ステップ3へ

### 3: 実装タスクリストの作成

- **担当**: Claude主導、人間レビュー
- **内容**: リファクタリングの実装タスク一覧を作成する
- **入力**:
  - テスト計画書（`docs/refactoring/test-plans/test-plan.md`）
  - テストコード（`Java/src/test/java/com/gildedrose/` 配下）
  - クラス設計書（`docs/refactoring/class-design.md`）
- **ガイドライン**:
  - 一度に大きく変更しないよう、小さな単位でタスクを分割する
  - まずインターフェース/抽象クラスの作成、次に具象クラスの実装、最後に既存コードの移行、という順序を意識する
  - **テンプレート**: `.claude/skills/refactoring/references/implementation-tasks-template.md` を参照して作成する
- **成果物**: `docs/refactoring/implementation-tasks.md`
- **人間による判定**:
  - OK → ステップ4へ
  - NG → ステップ3のやり直し

### 4: リファクタリングの実行

このステップは、実装タスクリストの全タスクが完了するまで繰り返します。各イテレーションでは必ず1つのタスクのみを完了させ、テストがパスすることを確認してから次のタスクに進みます。

#### 4-1: 次のリファクタリングステップの決定

- **担当**: Claude主導
- **内容**: 実装タスクリストから、次に実装するタスクを選択する
- **成果物**: なし（決定のみ）

#### 4-2: コードの実装

- **担当**: Claude主導
- **制約**:
  - **Item.javaは絶対に変更してはいけない**
  - クラス設計書（`docs/refactoring/class-design.md`）で定義された設計に従うこと
  - 必要に応じて，Javaの書き方ベストプラクティス（`.claude/skills/refactoring/references/java-best-practices.md`）を参照すること
- **成果物**: 新規クラスファイルまたは既存の実装コード/テストコードの修正

#### 4-3: テストの実行（Green状態の確認）

- **担当**: Claude主導、人間レビュー
- **内容**: `./gradlew test` でテストを実行し、以下を確認する
  - 4-1で決定した実装単位のテストがパスすること
  - 既存のパスしていたテストも引き続きパスすること（リグレッションがないこと）
- **成果物**: なし（確認のみ）
- **判定**:
  - テスト失敗 → ステップ4-2に戻って修正
  - テストパス → 人間レビューへ
- **人間による判定**:
  - OK → ステップ4-4へ
  - NG → ステップ4-2に戻って修正

#### 4-4: 実装タスクリストの更新

- **担当**: Claude主導
- **内容**: 実装タスクリストを更新する
  - 完了したタスクにチェックマークを付ける
  - 実装中に発見した新規タスクがあれば追加する
- **成果物**: `docs/refactoring/implementation-tasks.md` の更新

#### 4-5: リファクタリング完了判定

- **担当**: Claude主導、人間判断
- **内容**: 実装タスクリストを確認し、全てのタスクが完了したか判定
- **判定**:
  - 完了 → ステップ5へ
  - 未完了 → ステップ4-1に戻る

### 5: 最終確認

- **担当**: Claude主導
- **内容**: 以下を確認する
  - `./gradlew test` で全テストがパスすること
  - クラス設計書で定義された全てのクラス/インターフェースが実装されていること
  - 既存の動作が維持されていること
- **成果物**: なし（確認のみ）
- **判定**: 全て満たせばフェーズ5へ

## 注意事項

- Item.javaは変更してはいけない
- 各ステップで必ずテストを実行し、Green状態を維持する
- リファクタリングは小さなステップで行う（一度に大きく変更しない）
- コンパイルエラーやテスト失敗が発生したら、即座に修正する
- 既存の動作を変更してはいけない（テストがパスし続けること）
- テストコードもリファクタリングに伴って必要に応じて修正・追加して良い
