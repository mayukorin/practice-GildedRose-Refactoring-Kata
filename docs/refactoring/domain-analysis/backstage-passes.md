# Backstage passes のドメイン分析

## 1. 振る舞いの整理

### 1.1 主要な振る舞い

- **振る舞い1: 販売期限の減少**
  - Gherkin仕様書: すべてのシナリオで、1日経過すると販売期限（コンサートまでの日数）が1減少する
  - 分析資料: sellInは毎日-1される（コンサート開催日までの残り日数を表す）

- **振る舞い2: 段階的な品質向上（期限による加速）**
  - **11日以上前**: Gherkin仕様書「コンサート11日以上前では毎日品質が1ずつ向上する」
  - **10日以内**: Gherkin仕様書「コンサート10日以内では毎日品質が2ずつ向上する」
  - **5日以内**: Gherkin仕様書「コンサート5日以内では毎日品質が3ずつ向上する」
  - 分析資料: sellInの値によって、quality +1/+2/+3 の3段階で増加

- **振る舞い3: コンサート終了後の価値喪失**
  - Gherkin仕様書: 「コンサート終了後に品質が0になる」（Rule）、「コンサート当日で次の日に品質が0になる」（Scenario）
  - 分析資料: sellIn <= 0 になると、quality = 0（即座にゼロ化）

- **振る舞い4: 品質の上限制約**
  - Gherkin仕様書: 「Sulfuras以外のアイテムは品質値が50を超えない」（共通ルール）
  - 分析資料: quality は 50 を超えない

### 1.2 振る舞いのパターン

- **sellInの変化パターン**:
  - 毎日必ず-1される
  - 値の下限はない（負の値も取り得る）
  - **他のアイテム（Sulfuras以外）と同じパターン**

- **qualityの変化パターン**:
  - **sellIn >= 11**: quality +1
  - **6 <= sellIn <= 10**: quality +2
  - **1 <= sellIn <= 5**: quality +3
  - **sellIn <= 0**: quality = 0（ゼロ化）
  - **境界条件**: quality上限チェックは各増加ステップで行われる
    - quality = 49 で10日以内: +1 のみ（+2にならない）
    - quality = 48 で5日以内: +2 のみ（+3にならない）
    - quality = 49 で5日以内: +1 のみ（+3でも+2でもない）

- **特殊ルール**:
  - quality は 0 以上 50 以下
  - sellIn = 0 の日は「コンサート当日」だが、実装上は「コンサート終了扱い」（quality = 0が適用される）
  - 複数の閾値（11, 6, 1, 0）で振る舞いが段階的に変化する

## 2. ドメイン概念の抽出

### 2.1 このアイテムの特徴

- **特徴1: 期限接近による段階的価値向上（Gradual appreciation based on deadline proximity）**
  - **説明**: コンサートに近づくにつれて、チケットの価値（品質）が段階的に上昇する
  - **具体例**:
    - Gherkin仕様書: 品質が10のBackstage passesがコンサート11日前の場合、1日経過すると品質は11になる（+1）
    - Gherkin仕様書: 品質が10のBackstage passesがコンサート10日前の場合、1日経過すると品質は12になる（+2）
    - Gherkin仕様書: 品質が10のBackstage passesがコンサート5日前の場合、1日経過すると品質は13になる（+3）
    - 分析資料: デシジョンテーブル#1, #4, #7（sellInの範囲によって +1/+2/+3）

- **特徴2: イベント終了時の価値喪失（Value loss after event）**
  - **説明**: コンサートが終了すると、チケットは価値を失い、品質が即座に0になる
  - **具体例**:
    - Gherkin仕様書: 品質が10のBackstage passesがコンサート当日の場合、1日経過すると品質は0になる
    - 分析資料: デシジョンテーブル#11（sellIn <= 0 → quality = 0）

- **特徴3: 複数の閾値による状態変化（Multiple thresholds for state transitions）**
  - **説明**: 4つの異なるsellIn閾値（11, 6, 1, 0）で振る舞いが変化する
  - **具体例**:
    - Gherkin仕様書: 各Ruleで異なる閾値が定義されている（11日以上前、10日以内、5日以内、終了後）
    - 分析資料: 境界値分析3.1（sellIn = 11, 6, 1, 0 が重要な境界）

- **特徴4: 品質上限（Quality ceiling）**
  - **説明**: 品質は50を超えない（+2や+3の増加でも上限を超えない）
  - **具体例**:
    - Gherkin仕様書: 品質が50のBackstage passesは、コンサート何日前であっても、次の日になっても品質は50のままである
    - Gherkin仕様書: 品質が49/48のBackstage passesがコンサート5日前の場合、1日経過すると品質は50になる（52や51にはならない）
    - 分析資料: デシジョンテーブル#3, #6, #10（quality = 50 → quality変化なし）

- **特徴5: 境界条件での特殊な振る舞い（Boundary behavior）**
  - **説明**: 品質が上限近傍の場合、増加量が制限される
  - **具体例**:
    - 分析資料: デシジョンテーブル#5（sellIn = 6-10, quality = 49 → +1 のみ）
    - 分析資料: デシジョンテーブル#8（sellIn = 1-5, quality = 48 → +2 のみ）
    - 分析資料: デシジョンテーブル#9（sellIn = 1-5, quality = 49 → +1 のみ）

## 3. 他のアイテムタイプとの比較（メモ）

### 他のアイテムとの共通点
- sellInの減少ルール（毎日-1）は、Sulfuras以外の全アイテムに共通する
- 品質の上限制約（50）は、Aged Brieと同じ
- 品質が向上する方向性は、Aged Brieと同じ

### 他のアイテムとの相違点
- **Backstage passesの特徴**: 時間経過で品質が「段階的に向上」する（+1/+2/+3）が、イベント終了後は「ゼロ化」する
- **他のアイテムとの違い**:
  - 通常アイテム: 劣化（-1/-2）、下限0、期限切れで2段階の変化
  - Aged Brie: 向上（+1/+2）、上限50、期限切れで2段階の変化
  - Backstage passes: **段階的向上（+1/+2/+3） + 終了後ゼロ化**、上限50、**4段階の状態変化**
- **最も複雑な振る舞い**:
  - Backstage passesは4つの異なる状態（11日以上前、10日以内、5日以内、終了後）を持つ
  - 他のアイテムは2つの状態（期限内、期限切れ）のみ

### フェーズ2への示唆
- Backstage passesの「段階的向上」は、sellInの値によって戦略を切り替える設計が適している（Strategy パターン）
- 「イベント終了後のゼロ化」は、他のアイテムとは異なる特殊な振る舞いであり、明示的なモデル化が必要
- 複数の閾値（11, 6, 1, 0）を管理する仕組みが必要

※このセクションの内容は、フェーズ2のクラス設計で活用されます。
