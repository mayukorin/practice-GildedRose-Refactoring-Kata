# イテレーション3 振り返り - Sulfuras

**対象アイテム**: Sulfuras, Hand of Ragnaros
**実施日**: 2025-12-30
**ステータス**: 完了

## 実施した作業

### フェーズ1: 要件収集・分析
- ✓ analysis.md作成（要件抽出、コード分析、差分分析）
- ✓ 確定仕様書作成 (`final-analysis.md`)
- ✓ 人間レビュー完了（初期品質値80を前提条件として扱うことを確認）

### フェーズ2: 振る舞いの形式化
- ✓ 状態遷移図作成（Mermaid形式、UML記法）
- ✓ デシジョンテーブル作成
- ✓ 境界値分析
- ✓ テストケースへの示唆を記載
- ✓ 人間レビュー完了（修正なし、そのまま次フェーズへ）

### フェーズ3: Gherkin仕様書の作成
- ✓ ステップ3-1: Ruleの抽出（1つのSulfuras固有Rule）
- ✓ 人間レビュー完了（フィードバックに基づき調整）
- ✓ ステップ3-2: Scenarioの作成（1つのシンプルなScenario）
- ✓ 人間レビュー完了（フィードバックに基づき調整）
- ✓ 共通ルールの修正（品質50の上限の例外を明記）

## Keep（良かったこと、続けたいこと）

### 1. 確立されたプロセスの安定性
イテレーション1、2で確立されたプロセスをそのまま適用した結果、非常にスムーズに進行した：
- analysis.md + final-analysis.md の2ファイル構成
- フェーズ2の簡潔化ガイドライン
- フェーズ3の段階的アプローチ（Rule抽出 → Scenario作成）

**効果**:
- 各フェーズでの迷いがなくなった
- 初回出力の品質が高く、大きな修正が不要だった
- プロセス改善のサイクルが機能している証拠

### 2. 特殊ケース（不変アイテム）への柔軟な対応
Sulfurasは通常アイテムやAged Brieと根本的に異なる（状態遷移がない）が、同じプロセスで問題なく分析できた：
- 状態遷移図: 単一の不変状態として表現
- デシジョンテーブル: 1行のシンプルな表
- 境界値分析: sellInの値に関わらず変化なしを確認

**学び**: 確立されたプロセスは、異なる性質のアイテムにも適用可能

### 3. ユーザーフィードバックによる仕様の明確化
フェーズ3でユーザーから以下のフィードバックを得て、仕様がより明確になった：
- 販売期限については言及不要（「そもそも売られていない」）
- 品質が「変化しない」ではなく「80で一定である」と明記
- アイテム名を鉤括弧で囲んで「Sulfuras, Hand of Ragnaros」と厳密に明記

**効果**:
- 仕様の曖昧さが排除された
- テスト実装時の判断が容易になる
- ドメイン知識が仕様書に反映された

### 4. ユーザーフィードバックによる仕様の改善
フェーズ3で、ユーザーからのフィードバックにより仕様がより明確になった：
- 販売期限の扱い（言及不要）
- 品質の記述方法（「変化しない」→「80で一定である」）
- アイテム名の明記方法（鉤括弧で囲む）
- 共通ルールとの矛盾の発見（品質50の上限の例外）

**効果**: フィードバックを受けることで、仕様の曖昧さが排除され、より明確になった

### 5. シンプルさの追求
Sulfurasの振る舞いは非常にシンプル（不変）なため、Scenarioも1つのみで十分だった：
- 複雑にしようとせず、必要最小限に留めた
- 「販売期限が正/負」など不要な分岐を避けた
- 「品質が80のままである」という本質だけに焦点を当てた

**効果**: 仕様書が読みやすく、保守しやすくなった

## Problem（問題点、課題）

### 1. 既存のGherkin仕様書との矛盾を自力で発見できなかった
Sulfurasのセクションを追加した際、共通ルール「すべてのアイテムは品質値が50を超えない」とSulfurasの「品質80」が矛盾していることに気づかず、ユーザーの指摘を受けてから修正した。

**原因分析**:
- 新しいセクションを追加する際、既存の仕様書全体をレビューしなかった
- 共通ルールとの整合性チェックを怠った
- 「品質80」という例外的な値が、共通ルールに影響することを見落とした

**影響**:
- ユーザーの負担増加（本来はClaude側で発見すべき問題）
- 仕様書の一貫性に一時的な問題が発生

**本来あるべき対応**:
- Sulfurasのセクションを追加する前に、既存の共通ルールを確認
- 品質80という値が共通ルール（品質≤50）と矛盾することを自力で発見
- 共通ルールの修正を提案（「Sulfuras以外のアイテムは品質値が50を超えない」）
- ユーザーに確認を求める

## Try（次回試すこと、改善案）

### 1. 新規アイテム追加時の既存仕様との整合性チェック（必須改善）

**問題の再確認**:
今回、Sulfurasのセクションを追加した際に、共通ルールとの矛盾を自力で発見できなかった（Problem #1）。

**改善提案**:
新しいアイテムタイプのGherkin仕様書を作成する際、**Rule/Scenarioを追加する前に**、以下を必ず確認：

1. **既存の共通ルールを読み直す**:
   - gilded-rose.featureの「共通ルール」セクションを確認
   - 新しいアイテムの特性が、既存の共通ルールに適合するか検証

2. **矛盾点を洗い出す**:
   - 品質の上限/下限に関する制約
   - sellInの扱いに関する制約
   - その他の共通制約

3. **例外を明確にする**:
   - 共通ルールの例外となる場合、どのように明記すべきか提案
   - 「〜以外のアイテムは」という表現で例外を明示

4. **ユーザーに確認を求める**:
   - 共通ルールの修正が必要な場合、提案してから実施

**期待効果**:
- ユーザーの負担軽減（Claude側で矛盾を発見）
- 仕様書の一貫性を早期に確保
- 後戻りの防止

**適用タイミング**: 次のアイテム（Backstage passes）で必ず適用する

## Learn（学び、気づき）

### 1. プロセスの成熟度
イテレーション3では、確立されたプロセスをそのまま適用するだけで、高品質な成果物が得られた。これは、イテレーション1、2での改善が確実に効果を発揮している証拠。

**学び**: 継続的な振り返りと改善により、プロセスは成熟していく。

### 2. 不変性という特殊ケースの扱い
Sulfurasは「変化しない」という点で、通常アイテムやAged Brieと根本的に異なる：
- 状態遷移図: 単一状態、遷移なし
- デシジョンテーブル: 1行のみ
- Scenario: 1つで十分

**学び**: シンプルなものはシンプルに表現する。複雑にする必要はない。

### 3. 統合仕様書の価値
個別のアイテムタイプを統合したGherkin仕様書（gilded-rose.feature）を作成することで：
- アイテム間の矛盾を発見できた（共通ルールとSulfurasの品質上限）
- 例外を明示的に記載できた（「Sulfuras以外のアイテムは〜」）
- 仕様全体の一貫性を確保できた

**学び**: 統合仕様書は、個別の分析では見えない問題を明らかにする。

### 4. ドメイン知識の重要性
「販売されない」という要件から、「販売期限については言及不要」という判断ができた。これはドメイン知識（ビジネスロジック）の理解が必要。

**学び**: 要件文の字面だけでなく、その背後にあるドメイン知識を理解することが重要。

### 5. フィードバックによる改善
初回のGherkin仕様書はシンプルだったが、ユーザーのフィードバックにより、さらに明確で簡潔になった：
- 不要な情報（販売期限の状態）を削除
- 重要な情報（品質80、正確なアイテム名）を強調
- 本質（不変性）に焦点を当てた

**学び**: ユーザーフィードバックは仕様の品質を高める貴重な機会。

## 次のイテレーションへの引き継ぎ

### 次のアイテムタイプ（Backstage passes）

**必須の改善適用**:
- **Try #1を必ず適用**: 新規アイテム追加時の既存仕様との整合性チェック
  - フェーズ3（Gherkin仕様書作成）の前に、既存の共通ルールを確認
  - 矛盾点を自力で発見し、ユーザーに提案する
  - Problem #1の再発を防ぐ

**継続事項**:
- 確立されたプロセスを継続適用する
  - analysis.md + final-analysis.md の2ファイル構成
  - フェーズ2の簡潔化ガイドライン
  - フェーズ3の段階的アプローチ（Rule抽出 → Scenario作成）

**Backstage passesの特性**:
- 複雑な振る舞い（段階的な品質向上：10日/5日の閾値）を持つ
- デシジョンテーブルや境界値分析が重要になる
- 共通ルール（品質上限50）との整合性を確認

### スキル定義の更新（全完了後）
- 新規アイテム追加時の既存仕様との整合性チェックをガイドラインに追加（必須）

## アクションアイテム

- [x] フェーズ1完了
- [x] フェーズ2完了
- [x] フェーズ3完了
- [x] 共通ルールの修正完了
- [ ] 次のアイテムタイプ（Backstage passes）に着手する
  - **Try #1を必ず適用**（既存仕様との整合性チェック）
- [ ] 全アイテム完了後、スキル定義を更新する
  - 新規アイテム追加時の既存仕様との整合性チェックをガイドラインに追加

## 所感

イテレーション3では、確立されたプロセスの有効性を再確認できました。

**プロセスの成熟**:
イテレーション1、2で確立されたプロセスをそのまま適用するだけで、各フェーズでスムーズに進行しました。大きな手戻りはなく、初回出力の品質が高かったです。

**特殊ケースへの対応**:
Sulfurasは「不変」という点で特殊でしたが、同じプロセスで問題なく分析できました。むしろ、シンプルさを追求することで、より明確な仕様書になりました。

**ユーザーフィードバックの価値**:
フェーズ3で複数回のフィードバックがありましたが、それにより仕様がより明確で簡潔になりました。フィードバックは仕様の品質を高める貴重な機会だと再認識しました。

**統合仕様書の効果と課題**:
個別のアイテムタイプを統合したGherkin仕様書を作成することで、共通ルールとの矛盾を発見できました。ただし、今回はユーザーの指摘により発見したため、次回は自力で矛盾を発見できるよう改善します。

**次のステップ**:
次のイテレーション（Backstage passes）では、**Try #1（新規アイテム追加時の既存仕様との整合性チェック）を必ず適用**し、Problem #1の再発を防ぎます。Backstage passesは複雑な振る舞い（段階的な品質向上）を持つため、デシジョンテーブルや境界値分析が重要になると予想されます。
