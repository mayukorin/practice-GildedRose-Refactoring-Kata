# イテレーション4: Backstage passes 振り返り

**日付**: 2025-12-30
**対象アイテム**: Backstage passes to a TAFKAL80ETC concert
**担当**: Claude + 人間

## イテレーション概要

Backstage passesの要件定義書を作成しました。このアイテムは、コンサートまでの残り日数によって品質増加速度が段階的に変わり（+1/+2/+3）、コンサート終了後に価値がなくなるという、これまでで最も複雑な振る舞いを持つアイテムでした。

## うまくいった点（GOOD）

### 1. 状態遷移図のシンプル化

**内容**: 当初、状態遷移図で far, medium, near, max, expired という5つの状態を定義していたが、人間からのフィードバックで normal, max, zero の3つの状態にシンプル化した。

**効果**:
- 状態遷移図とデシジョンテーブルの役割分担が明確になった
- 状態遷移図は高レベルの状態を示し、詳細な変化速度（+1/+2/+3）はデシジョンテーブルに任せる形になった
- 可読性が向上し、理解しやすくなった

**学び**: 図表は必要最小限の情報に絞り、詳細は別の手段で表現する方が良い

### 2. 境界値分析の簡潔化

**内容**: 当初、「3.3 同時境界」「3.4 境界の組み合わせ」という冗長なセクションを含めていたが、人間からのフィードバックで削除した。また、各sellIn範囲ごとの詳細な理由説明も削除し、表だけを残した。

**効果**:
- デシジョンテーブルとの重複が解消された
- 境界値分析がシンプルで読みやすくなった
- 役割分担が明確になった（表で結果を示し、理由はデシジョンテーブルで推測可能）

**学び**: 重複を避け、必要な情報を簡潔にまとめることが重要

### 3. Gherkin Scenarioの境界値重視

**内容**: 当初、中間値（15日前、7日前、3日前など）のシナリオも含めていたが、人間からのフィードバックで境界値のみに絞った。

**効果**:
- Scenarioの数が適切になり、テストが管理しやすくなった
- 境界値をテストすれば、その範囲内の振る舞いは保証されるという原則が明確になった

**学び**: テストは境界値に焦点を当て、中間値は省略できる

### 4. フェーズ1の段階的承認

**内容**: フェーズ1では、ステップ1-1〜1-3までの分析を行った後、ステップ1-4（final-analysis.md作成）の前に人間レビューを挟んだ。

**効果**:
- コードの実装を「正」とする判断を人間が確認してから次に進めた
- 大きな手戻りを防げた

**学び**: 重要な判断の前に人間レビューを挟むことで、方向性の確認ができる

## 問題点（PROBLEM）

### 問題1: フェーズ2からフェーズ3への自動移行

**内容**: フェーズ2（振る舞いの形式化）が完了した後、人間のOKを待たずに、自動的にフェーズ3（Gherkin仕様書の作成）に移行してしまった。

**影響**:
- 人間が振る舞いの形式化（状態遷移図、デシジョンテーブル）をレビューする機会がなかった
- フェーズ1では適切に人間レビューを挟んでいたが、フェーズ2では挟まなかった

**根本原因**:
- behavior-formalization.md の「ステップ2-1: テスト分析」には「人間レビュー」と書かれているが、Claude が明示的に人間のOKを求めなかった
- フェーズ間の遷移タイミングが不明確だった

**期待される振る舞い**:
- フェーズ2完了後、人間にレビューを依頼し、OKが出るまでフェーズ3に進まない
- フェーズ1と同様の段階的承認アプローチを適用すべき

### 問題2: Gherkin仕様書作成時の手順無視

**内容**: Gherkin仕様書を作成する際、gherkin-specification.md に記載された手順（ステップ3-1: Ruleのみ作成 → ステップ3-2: Scenario作成）を参照せず、いきなり Rule と Scenario の両方を書いてしまった。

**影響**:
- 段階的承認のアプローチが機能しなかった
- 人間がRuleの構造をレビューする前に、Scenarioまで書いてしまった
- 結果的に人間が止めて、Ruleのみを先に作成するように指示する必要があった

**根本原因**:
- gherkin-specification.md の手順を確認したにもかかわらず、それを守らなかった
- 「Gherkin仕様書を作成してください」という指示を受けて、一気に完成させようとしてしまった

**期待される振る舞い**:
- gherkin-specification.md の手順に厳密に従う
- ステップ3-1でRuleのみを作成し、人間のOKを得てから、ステップ3-2でScenarioを作成する

## 改善策（ACTION）

### 改善策1: フェーズ間の明示的な承認プロセス

**対応**:
1. skill.md に、各フェーズ完了後に明示的に人間の承認を求めることを追記する
2. 各フェーズの最後に「このフェーズの成果物は以下です。レビューをお願いします。OKが出たら次のフェーズに進みます」というメッセージを出す
3. behavior-formalization.md の最後に「人間レビュー待ち」のステップを明示する

**実装方法**:
```markdown
## フェーズ2完了時のチェックポイント

フェーズ2が完了したら、以下を人間に提示してレビューを依頼する：

**成果物**:
- `docs/analysis/[item-type].md`

**確認事項**:
- 状態遷移図は適切か
- デシジョンテーブルは網羅的か
- 境界値分析は十分か

**次のステップ**:
人間から明示的なOKが出るまで、フェーズ3には進まない。
```

### 改善策2: Gherkin作成手順の厳格化

**対応**:
1. gherkin-specification.md の冒頭に、「この手順は厳密に守ること。ステップを飛ばさないこと」という注意書きを追加
2. ステップ3-1とステップ3-2の間に、明確な承認待ちポイントを設ける
3. Claude が「Gherkin仕様書を作成してください」という指示を受けた場合でも、まずステップ3-1のみを実行し、人間のOKを待つ

**実装方法**:
```markdown
## 重要: 段階的承認の必須化

**ステップ3-1完了時**:
- Ruleのみを作成したら、必ず人間にレビューを依頼する
- 「Ruleを追加しました。これらのRuleで問題ないか確認をお願いします。OKであれば、次のステップ3-2でScenarioを作成します」と明示的に伝える
- 人間から明示的なOKが出るまで、ステップ3-2には進まない

**禁止事項**:
- RuleとScenarioを同時に作成してはいけない
- 段階的承認のステップを飛ばしてはいけない
```

### 改善策3: システムメッセージの追加

**対応**:
skill.md に、Claude がフェーズ間やステップ間で必ず人間に確認を求めるようにするシステムメッセージを追加する。

**実装方法**:
```markdown
## Claude への指示

各フェーズおよびステップの完了時には、以下のパターンでメッセージを出力すること：

1. 成果物の提示
2. 確認事項の列挙
3. 「OKが出たら次に進みます」という明示的な待機メッセージ
4. 次のステップの予告

例:
> フェーズ2が完了しました。以下の成果物を作成しました：
> - `docs/analysis/backstage-passes.md`
>
> 確認事項：
> - 状態遷移図は適切ですか？
> - デシジョンテーブルは網羅的ですか？
>
> OKが出たら、フェーズ3（Gherkin仕様書の作成）に進みます。
```

## 次のイテレーションへの引き継ぎ事項

### 1. Conjured itemsへの適用

次のアイテムタイプは Conjured items（新機能）です。以下の点に注意：
- Conjured itemsは「通常のアイテムの2倍の速さで品質が劣化する」という新機能
- 既存コードには実装されていないため、要件定義のみから仕様を作成する必要がある
- 通常アイテムの仕様を参考にしながら、2倍速劣化のルールを明確にする

### 2. 改善策の適用

このイテレーションで特定した改善策を、次のイテレーションで適用する：
- フェーズ2完了後、明示的に人間のOKを求める
- Gherkin作成時、Ruleのみを先に作成し、人間のOKを得てからScenarioを作成する

### 3. ドキュメントの更新

skill.md、behavior-formalization.md、gherkin-specification.md を更新し、段階的承認プロセスを明確にする。

## まとめ

Backstage passesのイテレーションでは、複雑な振る舞いを持つアイテムの仕様を作成できました。人間からのフィードバックにより、状態遷移図や境界値分析をシンプル化し、より理解しやすい形にできました。

一方で、フェーズ間の承認プロセスとGherkin作成手順の遵守に課題が見つかりました。これらは次のイテレーションで改善し、よりスムーズな要件定義プロセスを確立します。

**全体的な評価**: 成果物の品質は高いが、プロセスの改善余地あり
