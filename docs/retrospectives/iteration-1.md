# イテレーション1 振り返り - 通常アイテム

**対象アイテム**: 通常アイテム (Normal items)
**実施日**: 2025-12-29
**ステータス**: フェーズ2完了（レビュー中）

## 実施した作業

### フェーズ1: 要件収集・分析
- ✓ 要件抽出 (`requirements-extraction.md`)
- ✓ コード分析 (`code-analysis.md`)
- ✓ 差分分析 (`gap-analysis.md`)
- ✓ 確定仕様書作成 (`final-analysis.md`) ← **新規追加**

### フェーズ2: 振る舞いの形式化
- ✓ 状態遷移図作成（Mermaid形式）
- ✓ デシジョンテーブル作成
- ✓ 境界値分析
- ✓ エッジケース洗い出し（10ケース）
- 🔄 人間レビュー中

## Keep（良かったこと、続けたいこと）

### 1. フェーズ1の3段階分析
要件抽出、コード分析、差分分析の3ステップに分けたことで、以下のメリットがありました：
- 要件とコードの違いを明確に把握できた
- sellIn = 0 の境界条件など、曖昧な仕様を特定できた
- レビュー時に論点が整理されていた

### 2. エッジケースの網羅的な洗い出し
10個のエッジケースを特定し、具体例を示したことで：
- テストケース作成の準備が整った
- 境界条件の理解が深まった
- フェーズ3（Gherkin作成）での漏れを防げそう

### 3. Mermaid記法による図表化
状態遷移図をMermaidで作成したことで：
- バージョン管理が容易
- テキストベースで編集・レビューしやすい
- 将来的な更新が簡単

## Problem（問題点、課題）

### 1. フェーズ1の成果物の散在
`requirements-extraction.md`, `code-analysis.md`, `gap-analysis.md` の3つがあり、「結局どれが正？」が不明確でした。

**影響**:
- レビュー時に3つのファイルを行き来する必要があった
- 次フェーズで参照すべきファイルが分かりにくい

### 2. 状態遷移図の初期設計の問題
最初の状態遷移図では：
- 状態を概念的な名前（「期限内」「期限切れ」）で定義していた
- SellInの状態遷移図なのにQualityの変化も含めていた

**影響**:
- 状態遷移図として正確性に欠けた
- 関心の分離ができていなかった

### 3. 状態遷移図の書き方が微妙
UML の記法使ってちゃんと書きたい

### 4. 初回で完成したanalysis/normal-item.md が結構冗長だった．
Claude にここ冗長なので削除して，と何回か指示した．

### 5. Gherkin仕様書の一括レビューによる手戻りリスク
フェーズ3のステップ3-1で、Gherkinシナリオ全体（Rule、Scenario、Examples等）を一度に作成してからレビューに回すアプローチを取った。

**影響**:
- Ruleの抽出・構造化の部分に問題があった場合、Scenario全体の修正が必要になる可能性がある
- レビューポイントが多岐にわたり、レビューの負担が大きい
- 大きな粒度での手戻りが発生するリスクがある

**所感**:
いきなりGherkin全体をレビューするのではなく、まずRuleだけをClaudeに書いてもらってから人間レビューを通した方が、手戻りなく進められるのではないか。

## Try（次回試すこと、改善案）

### 1. フェーズ1のファイル構成改善（改善案確定: 2025-12-30）

**問題点**:
- 3つのファイル（requirements-extraction.md, code-analysis.md, gap-analysis.md）が散在
- レビュー時に複数ファイルを行き来する必要があった
- 「結局どれが正？」が不明確

**改善案**:
ファイル構成を2ファイルに集約：

```
docs/requirements/[item-type]/
├── analysis.md           # ステップ1-1〜1-3の詳細な分析プロセス
└── final-analysis.md     # ステップ1-4の確定仕様（簡潔版）
```

**各ファイルの役割**:
- **analysis.md**:
  - 要件抽出、コード分析、差分分析をセクション分けして1ファイルに記載
  - 思考プロセスと詳細な分析内容を保持
  - レビュー時の検討内容を記録

- **final-analysis.md**:
  - 確定した仕様ルールのみを簡潔に記載
  - レビューでの決定事項を明記
  - 次フェーズへの引き継ぎ事項
  - 詳細が必要な場合はanalysis.mdを参照するよう記載

**ステップの流れ**:
1. **ステップ1-1**: Claudeが`analysis.md`に「## 1. 要件抽出」セクションを記載
2. **ステップ1-2**: Claudeが`analysis.md`に「## 2. コード分析」セクションを追記
3. **ステップ1-3**: Claudeが`analysis.md`に「## 3. 差分分析」セクションを追記、人間がレビュー
4. **ステップ1-4**: Claudeが`analysis.md`を元に`final-analysis.md`を作成（簡潔版）、人間が承認

**期待効果**:
- ファイル数が減り、作業がシンプルになる
- レビュー時に複数ファイルを行き来する必要がない
- Claudeが前のステップの内容を参照しやすい
- フェーズ1完了時に「単一の正」（final-analysis.md）が明確になる
- 思考プロセス（analysis.md）と結論（final-analysis.md）が分離され、用途に応じて参照できる

**スキル定義への反映**:
次回以降のアイテムタイプで実際に適用し、効果を検証した後、スキル定義ファイル (`.claude/skills/spec-driven-requirements/skill.md`) を更新する。

### 2. 状態遷移図のベストプラクティス

**改善内容**:
状態遷移図を作成する際の指針：

#### 2-1. 状態・イベント・アクションの定義
- **状態**: 対象属性の値で分類する（例: `sellIn >= 1`, `quality > 0`）
- **イベント**: 遷移のトリガー（例: 「1日経過」「updateQuality()」）
- **アクション**: その属性の変化のみ記載（関心の分離）
  - SellInの状態遷移 → sellInの変化のみ
  - Qualityの状態遷移 → qualityの変化のみ
- **複合的な振る舞い**: デシジョンテーブルや処理フローで表現

#### 2-2. UML状態遷移図の正しい記法

**標準記法**: `イベント [ガード条件] / アクション`

- **イベント**: 遷移のトリガー（例: `1日経過`）
- **[ガード条件]**: 遷移が起こるための条件を角括弧で囲む（例: `[sellIn = 1]`）
- **/ アクション**: 遷移時に実行される処理（例: `/ sellIn -= 1`）

**具体例**:
```
sellIn >= 1 → sellIn = 0: 1日経過 [sellIn = 1]
quality > 0 → quality > 0: 1日経過 [sellIn >= 1] / quality -= 1
quality > 0 → quality > 0: 1日経過 [sellIn <= 0] / quality -= 2
```

**間違いやすいポイント**:
- ❌ `1日経過 / sellIn -= 1` （ガード条件なしでアクションのみ）
  - これだと「sellIn が 1 の時だけ遷移する」という条件が表現できない
- ✅ `1日経過 [sellIn = 1]` （イベント＋ガード条件）
  - sellIn が 1 の時だけ、この遷移が起こることを明示

**ガード条件の活用**:
- Qualityの状態遷移で、sellInの状態をガード条件として使用できる
- 例: `1日経過 [sellIn >= 1] / quality -= 1` と `1日経過 [sellIn <= 0] / quality -= 2`
- これにより、他の属性を条件として参照しつつ、対象属性の変化に集中できる

**期待効果**:
- UML記法として正確で、他の開発者にも理解しやすい
- ツール（PlantUML、Mermaidなど）での表現と一貫性が保たれる
- 状態遷移図として正確で分かりやすい
- 1つの関心事に集中できる
- 他のアイテムタイプでも一貫した表現になる

**適用状況**:
- 通常アイテムの状態遷移図に反映済み（iteration-1内で修正）
  - SellIn: ガード条件で遷移条件を明示
  - Quality: ガード条件でsellInの状態を参照、アクションでquality減少量を明示

### 3. レビューチェックリストの作成（次回以降）

**改善内容**:
各フェーズのレビュー時に使用するチェックリストを作成：
- フェーズ1: 要件の網羅性、コード分析の正確性、差分の特定
- フェーズ2: 状態遷移図の正確性、エッジケースの網羅性
- フェーズ3: Gherkin仕様書の可読性、要件との整合性

**期待効果**:
- レビューの観点が明確になる
- レビュー漏れを防げる
- 他のアイテムタイプでも一貫したレビューができる

### 4. フェーズ2のステップ統合とガイドライン強化（改善案確定: 2025-12-30）

**問題点**:
- ステップ2-1（分析図表の作成）とステップ2-2（エッジケース洗い出し）で内容が重複していた
- 状態遷移図を書く時点で境界値やエッジケースを考えているのに、ステップ2-2で再度同じことをリストアップする
- 「全部書かなきゃ」というモードになって冗長になった（Problem 4と関連）

**改善案**:
2ステップを1ステップに統合し、ハイブリッドアプローチを採用：

```
ステップ2-1: テスト分析
- 担当: Claude主導、人間レビュー
- 内容:
  - 仕様の振る舞いをテスト分析し、以下を含める：
    1. 振る舞いの可視化（状態遷移図またはデシジョンテーブル）
    2. 境界値分析
    3. エッジケース（図表で表現されていないものに限る）
  - 重複を避け、簡潔にまとめる
- 成果物: docs/analysis/[item-type].md
```

**アプローチの特徴**:
- **最低限のガイドライン**: 何を含めるべきかは明示（一貫性を保つ）
- **柔軟性**: 具体的な手法はClaudeに任せる（Claudeの自律性を活かす）
- **重複防止**: 「図表で表現されていないものに限る」を明示

**期待効果**:
- 分析図表とエッジケースの重複が減る
- 1つの連続したプロセスとして分析するため、自然と重複が避けられる
- Claudeが最適な分析方法を選べる
- 冗長さが減り、簡潔な成果物になる
- 最低限の一貫性を保ちつつ、アイテムタイプに応じて柔軟に対応できる

**スキル定義への反映**:
次回以降のアイテムタイプで実際に適用し、効果を検証した後、スキル定義ファイル (`.claude/skills/spec-driven-requirements/skill.md`) を更新する。

### 5. フェーズ3のステップ分割（段階的アプローチ）（改善案確定: 2025-12-30）

**問題点**:
- 現在は、Gherkinシナリオ全体（Rule、Scenario、Examples等）を一度に作成してからレビューに回すアプローチ
- Ruleの抽出・構造化の部分に問題があった場合、Scenario全体の修正が必要になる可能性がある
- レビューポイントが多岐にわたり、レビューの負担が大きい
- 大きな粒度での手戻りが発生するリスクがある

**改善案**:
1ステップを2ステップに分割し、段階的アプローチを採用：

```
ステップ3-1: Ruleの抽出
- 担当: Claude主導、人間レビュー
- 内容: 分析図表からドメインルール（Rule）を抽出し、構造化する
- 成果物: docs/specifications/gilded-rose.feature に Rule のみを追記
- 判定: OK → ステップ3-2へ / NG → ステップ3-1のやり直し

ステップ3-2: Scenarioの作成
- 担当: Claude主導、人間レビュー
- 内容: 承認されたRuleをベースに、Scenario と Examples を作成する
- 成果物: docs/specifications/gilded-rose.feature に Scenario を追記
- 判定: OK → フェーズ4へ / NG → ステップ3-2のやり直し
```

**アプローチの特徴**:
- **段階的承認**: Ruleが確定してからScenarioを書くため、手戻りが少ない
- **レビューの焦点化**: 各ステップでレビューポイントが明確
- **リスク低減**: 大きな粒度での手戻りを防ぐ

**期待効果**:
- Ruleの構造が確定してからScenarioを書くため、手戻りが大幅に減る
- レビュー時に何をチェックすべきか明確になる
- レビューの負担が分散される
- 問題があった場合、該当ステップのみをやり直せば良い

**フェーズ2との違い**:
- フェーズ2: 2ステップ→1ステップに統合（重複を避けるため）
- フェーズ3: 1ステップ→2ステップに分割（手戻りリスクを減らすため）

**スキル定義への反映**:
次回以降のアイテムタイプで実際に適用し、効果を検証した後、スキル定義ファイル (`.claude/skills/spec-driven-requirements/skill.md`) を更新する。

## Learn（学び、気づき）

### 1. 境界条件の重要性
sellIn = 0 の扱いが、要件文書では曖昧でも、コードには明確な振る舞いがありました。
- **学び**: レガシーコードでは、コードが「真の仕様」である
- **気づき**: 境界条件こそ、最も注意深く分析すべきポイント

### 2. 状態遷移図の正確性
状態遷移図は、UMLの規則に従った正確な表現が重要です。
- **学び**: 状態は値で定義、イベントは遷移のトリガー、アクションは関心の分離
- **気づき**: 最初は間違えやすいので、レビューで修正するプロセスが有効

### 3. 段階的な成果物の価値
思考プロセスを記録することに価値がありました。
- **学び**: 最終成果物（final-analysis.md）だけでなく、分析プロセス（analysis.md）も保持する意義がある
- **気づき**: 後で見返したときに「なぜこの判断をしたか」が分かる
- **改善**: ファイルを分けすぎず、1つのファイルにセクション分けして記載する方が効率的

### 4. Mermaidの環境依存
Mermaidはバージョン管理に優れていますが、ビューアーに依存します。
- **学び**: IntelliJではプラグインが必要（Mermaid plugin）
- **気づき**: プロジェクトのREADMEに推奨環境/ツールを記載すべき

## 次のイテレーションへの引き継ぎ

### フェーズ3（通常アイテム）
- 状態遷移図とデシジョンテーブルをベースにGherkin仕様書を作成
- エッジケース10個をScenarioとして網羅する
- sellIn = 0 の境界条件を明示する

### 次のアイテムタイプ（Aged Brie、Sulfurasなど）
- 改善されたファイル構成（analysis.md + final-analysis.md）を適用する
- フェーズ2の統合されたテスト分析アプローチを適用する
- フェーズ3の段階的アプローチ（Rule → Scenario）を適用する
- 状態遷移図のベストプラクティスを適用する
- 通常アイテムとの対比を意識する

### スキル定義の更新（全完了後）
- フェーズ1のファイル構成改善を反映
- フェーズ2のステップ統合を反映
- フェーズ3のステップ分割を反映
- 状態遷移図のガイドライン追加
- レビューチェックリストの追加（オプション）

## アクションアイテム

- [ ] フェーズ2のレビューを完了する
- [ ] フェーズ3（Gherkin仕様書作成）を進める
- [ ] 通常アイテム完了後、Aged Brieに着手する（新ファイル構成を適用）
- [ ] フェーズ2、フェーズ3の改善案を検討・記録する
- [ ] 全アイテム完了後、スキル定義ファイルを更新する

## 所感

初めてのイテレーションでしたが、プロセスの有効性を確認できました。特に、フェーズ1での要件とコードの差分分析が、仕様理解に非常に役立ちました。`final-analysis.md` の追加提案や状態遷移図の改善など、実際にやってみることで気づきが得られました。

次回以降のアイテムタイプでは、これらの改善を最初から適用し、さらに効率的に進められると期待しています。
