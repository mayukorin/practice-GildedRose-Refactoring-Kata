# 通常アイテム - 確定仕様書

**作成日**: 2025-12-29
**最終更新**: 2025-12-29
**ステータス**: ✓ 確定（フェーズ1完了）

## このドキュメントについて

このドキュメントは、フェーズ1（要件収集・分析）の最終成果物です。
以下の3つの分析結果を統合し、レビュー後の確定仕様をまとめています：

- `requirements-extraction.md` - 要件文書からの抽出結果
- `code-analysis.md` - 既存実装の分析結果
- `gap-analysis.md` - 要件とコードの差分分析

**次フェーズでの使用**: この仕様書をベースに、フェーズ2（振る舞いの形式化）で状態遷移図またはデシジョンテーブルを作成します。

## アイテム定義

**通常アイテム (Normal items)** とは、以下の特殊アイテムのいずれにも該当しないアイテムです：
- "Aged Brie"
- "Backstage passes to a TAFKAL80ETC concert"
- "Sulfuras, Hand of Ragnaros"
- "Conjured" （今後追加予定）

## 確定仕様

### 基本ルール

1. **アイテムの属性**
   - `sellIn`: 販売期限の残り日数（整数）
   - `quality`: 品質・価値（整数）
   - `name`: アイテム名（文字列）

2. **品質の制約**
   - **下限**: 0（厳格に守られる、0未満にはならない）
   - **上限**: 50（通常アイテムは減少のみなので、初期値が50以下なら実質的に問題なし）

3. **sellIn値の制約**
   - **下限**: なし（負の値が継続的に減少する）

### 毎日の更新処理

通常アイテムは、`updateQuality` メソッドが呼ばれるたびに以下の処理を行います：

#### 処理フロー

```
[フェーズ1] Quality の初回減少
  ↓
[フェーズ2] SellIn の減少
  ↓
[フェーズ3] Quality の追加減少（期限切れ時のみ）
```

#### フェーズ1: Quality の初回減少

- **条件**: `quality > 0`
- **処理**: `quality -= 1`
- **スキップ**: `quality = 0` の場合

#### フェーズ2: SellIn の減少

- **条件**: なし（常に実行）
- **処理**: `sellIn -= 1`

#### フェーズ3: Quality の追加減少（期限切れ時のみ）

- **条件**: `sellIn < 0` **かつ** `quality > 0`
  - **重要**: sellInは**減少後の値**で判定される
- **処理**: `quality -= 1`
- **スキップ**: `sellIn >= 0` または `quality = 0` の場合

### 振る舞いパターン

| 更新前の状態 | SellIn変化 | Quality変化 | 備考 |
|------------|-----------|------------|------|
| sellIn >= 1 | -1 | -1 | 通常の劣化 |
| sellIn = 0 | -1 | **-2** | ⚠️ 期限当日も期限切れ扱い |
| sellIn <= -1 | -1 | -2 | 期限切れ後の2倍速劣化 |
| quality = 0 | -1 | 0 | 下限到達、品質変化なし |
| quality = 1, sellIn < 0 | -1 | -1 | フェーズ1で0到達、フェーズ3はスキップ |

### 重要な決定事項

#### sellIn = 0 の扱い

**決定**: sellIn = 0 の日は**期限切れ扱い**（quality -2）

**理由**:
- 既存実装では、sellInを減少させた**後**に `sellIn < 0` を判定する
- sellIn = 0 → -1 となった時点で、フェーズ3の条件を満たす
- この振る舞いを「正しい仕様」として採用する（レビュー承認済み）

**Gherkin仕様書での表現**:
- 「販売期限切れ」の定義: `sellIn < 0`（更新後の値）
- つまり、sellIn = 0 の日に更新すると、sellInが-1になり期限切れ扱いになる

## エッジケースと境界条件

### ケース1: 品質が下限に到達

**初期状態**: sellIn = 5, quality = 0

| 日 | 更新処理 | sellIn | quality |
|----|---------|--------|---------|
| 0 | (初期状態) | 5 | 0 |
| 1 | フェーズ1: スキップ（quality=0）<br>フェーズ2: sellIn-1<br>フェーズ3: スキップ | 4 | 0 |
| ... | 同様 | ... | 0 |

**結論**: quality = 0 になると、それ以上減少しない。

### ケース2: 販売期限の境界

**初期状態**: sellIn = 1, quality = 10

| 日 | 更新処理 | sellIn | quality |
|----|---------|--------|---------|
| 0 | (初期状態) | 1 | 10 |
| 1 | フェーズ1: quality-1 → 9<br>フェーズ2: sellIn-1 → 0<br>フェーズ3: スキップ（sellIn=0は<0でない） | 0 | 9 |
| 2 | フェーズ1: quality-1 → 8<br>フェーズ2: sellIn-1 → -1<br>フェーズ3: quality-1 → 7（sellIn=-1<0） | -1 | 7 |

**重要**: sellIn = 0 → -1 となる日（上記の「日2」）から、quality が -2 される。

**訂正**: 表を再確認します。

sellIn = 0 の日：
- フェーズ1: quality = 9 → 8
- フェーズ2: sellIn = 0 → -1
- フェーズ3: sellIn = -1 < 0 が true なので、quality = 8 → 7
- 結果: quality -2

正しい表：

| 日 | 更新処理 | sellIn | quality |
|----|---------|--------|---------|
| 0 | (初期状態) | 1 | 10 |
| 1 | quality-1, sellIn-1 | 0 | 9 |
| 2 | quality-1, sellIn-1, quality-1 | -1 | **7** |

### ケース3: 期限切れ時に品質が低い

**初期状態**: sellIn = 0, quality = 1

| 日 | 更新処理 | sellIn | quality |
|----|---------|--------|---------|
| 0 | (初期状態) | 0 | 1 |
| 1 | フェーズ1: quality-1 → 0<br>フェーズ2: sellIn-1 → -1<br>フェーズ3: スキップ（quality=0） | -1 | 0 |

**結論**: 期限切れでも、品質が0に到達したらそれ以上減少しない（-2にはならない）。

### ケース4: 期限切れ時に品質が十分ある

**初期状態**: sellIn = 0, quality = 10

| 日 | 更新処理 | sellIn | quality |
|----|---------|--------|---------|
| 0 | (初期状態) | 0 | 10 |
| 1 | フェーズ1: quality-1 → 9<br>フェーズ2: sellIn-1 → -1<br>フェーズ3: quality-1 → 8 | -1 | 8 |
| 2 | フェーズ1: quality-1 → 7<br>フェーズ2: sellIn-1 → -2<br>フェーズ3: quality-1 → 6 | -2 | 6 |

**結論**: sellIn <= 0 の日は、毎日 quality -2 される。

## 状態遷移の要点

### SellInの遷移

```
... → 2 → 1 → 0 → -1 → -2 → -3 → ...
            ↑
         この境界で劣化速度が変化
```

- sellIn >= 1: 通常劣化（quality -1）
- sellIn = 0: **期限切れ扱い**（quality -2）
- sellIn <= -1: 期限切れ（quality -2）

### Qualityの遷移

```
50 → ... → 3 → 2 → 1 → 0 → 0 → 0 → ...
                           ↑
                         下限で停止
```

- quality > 0: 減少処理が適用される
- quality = 0: 減少処理がスキップされる（下限制約）

## 次フェーズへの引き継ぎ事項

### フェーズ2（振る舞いの形式化）で重点的に扱うべき項目

1. **sellInの状態遷移**
   - 正の値 → 0 → 負の値の遷移
   - 各状態でのquality減少量の違い

2. **qualityの下限制約**
   - quality = 0 での振る舞い
   - quality = 1 で期限切れになった場合の挙動

3. **境界条件**
   - sellIn = 1 → 0 → -1 の遷移
   - quality = 2 → 1 → 0 の遷移（期限切れ時）

### Gherkin仕様書で明記すべき項目

1. **販売期限切れの定義**
   - 「sellIn < 0（更新後の値）」と明記
   - sellIn = 0 の日は期限切れ扱いになることを例示

2. **品質下限の厳格性**
   - quality は 0 未満にならない
   - 期限切れで -2 されるべき状況でも、0 で停止する

3. **減少量の明確化**
   - 期限内: quality -1/日
   - 期限切れ: quality -2/日（**最大**）
   - 実際の減少量は、下限制約により -1 または 0 になる場合がある

## まとめ

通常アイテムの仕様は以下のように確定しました：

✓ 毎日、sellIn と quality が減少する
✓ sellIn = 0 の日から期限切れ扱い（quality -2/日）
✓ quality の下限は 0（厳格に守られる）
✓ sellIn の下限はなし（負の値が継続）

この仕様をベースに、フェーズ2で振る舞いを形式化（状態遷移図またはデシジョンテーブル）し、フェーズ3でGherkin仕様書を作成します。
