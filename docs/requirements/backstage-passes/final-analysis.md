# Backstage passes to a TAFKAL80ETC concert 確定仕様

このドキュメントは、Backstage passesアイテムタイプの確定仕様を簡潔にまとめたものです。
詳細な分析プロセスは `analysis.md` を参照してください。

## 確定した仕様ルール

### R1: コンサート11日以上前のQuality増加
- **条件**: sellIn >= 11 かつ quality < 50
- **処理**: quality を +1
- **頻度**: 毎日
- **備考**: 「Aged Brieと同様」の基本増加パターン

### R2: コンサート10日以内のQuality増加（2倍速）
- **条件**: 6 <= sellIn <= 10 かつ quality < 50
- **処理**: quality を +2
- **頻度**: 毎日
- **備考**: コンサートが近づくことで価値が上昇

### R3: コンサート5日以内のQuality増加（3倍速）
- **条件**: 1 <= sellIn <= 5 かつ quality < 50
- **処理**: quality を +3
- **頻度**: 毎日
- **備考**: コンサート直前で価値が最大化

### R4: コンサート終了後のQuality初期化
- **条件**: sellIn <= 0
- **処理**: quality = 0 に設定
- **頻度**: 毎日
- **備考**: コンサート終了後、チケットは価値がなくなる

### R5: SellInの減少
- **条件**: 常に（Backstage passesも対象）
- **処理**: sellIn を -1
- **頻度**: 毎日

### R6: Qualityの上限
- **制約**: quality は50を超えない
- **実装**: 各増加処理の前に `quality < 50` をチェック
- **結果**: quality = 50 で増加が停止

### R7: Qualityの下限
- **制約**: quality は0未満にならない
- **実装**: コンサート終了後に quality = 0 に設定
- **結果**: quality は常に0以上

## 重要な決定事項

### 11日以上前の基本増加量について

**決定**: コードの実装を正式仕様として採用（+1/日）

**理由**:
1. 「Aged Brieと同様」という要件文の記述から、基本増加量を持つのは自然
2. コードの構造が明確（基本増加 + ボーナス）
3. Aged Brieの基本増加パターンと一貫性がある
4. 要件文は主要な振る舞い（10日以内、5日以内）を強調し、基本増加は省略したと解釈

### sellIn = 0（コンサート当日）の扱い

**決定**: コンサート終了扱い（quality = 0）

**理由**:
- コードでは sellIn を -1 してから期限切れ判定（sellIn < 0）を行う
- sellIn = 0 の場合も、-1 後に sellIn = -1 となりコンサート終了処理が適用される
- 通常アイテムやAged Brieと同じ解釈で一貫性がある
- コンサートは1日の中で終了するため、当日の終わりには価値が0になるのは妥当

### 増加量の表現方法

**決定**: 観察可能な結果（+1, +2, +3/日）を仕様書に記載

**理由**:
- テストや仕様書では、外部から観察できる振る舞い（結果）を記載するのが一般的
- 内部実装の詳細（基本+1 + ボーナス）は、コード分析資料（analysis.md）に残す
- 仕様書の可読性が向上

## 境界条件の確定

| 初期状態 | sellIn | quality | 1日後 sellIn | 1日後 quality | 説明 |
|---------|--------|---------|-------------|--------------|------|
| 11日以上前 | 15 | 10 | 14 | 11 | +1増加（基本速度） |
| 11日前（境界） | 11 | 10 | 10 | 11 | +1増加 |
| 10日前（境界） | 10 | 10 | 9 | 12 | +2増加（10日以内） |
| 6〜10日前 | 7 | 10 | 6 | 12 | +2増加 |
| 6日前（境界） | 6 | 10 | 5 | 12 | +2増加 |
| 5日前（境界） | 5 | 10 | 4 | 13 | +3増加（5日以内） |
| 1〜5日前 | 3 | 10 | 2 | 13 | +3増加 |
| 1日前 | 1 | 10 | 0 | 13 | +3増加 |
| 当日（境界） | 0 | 10 | -1 | 0 | コンサート終了 |
| 終了後 | -1 | 10 | -2 | 0 | コンサート終了 |
| 上限到達 | 10 | 50 | 9 | 50 | 増加しない |
| 上限直前 | 10 | 49 | 9 | 50 | +1のみ（上限で停止） |
| 上限2未満 | 3 | 48 | 2 | 50 | +2のみ（上限で停止） |
| 終了後（上限） | -1 | 50 | -2 | 0 | コンサート終了で0 |

## 処理フロー

```
毎日の処理:
  1. Quality増加（フェーズ1）
     IF quality < 50 THEN
       quality = quality + 1  // 基本増加

       // 10日以内ボーナス
       IF sellIn < 11 AND quality < 50 THEN
         quality = quality + 1
       END IF

       // 5日以内ボーナス
       IF sellIn < 6 AND quality < 50 THEN
         quality = quality + 1
       END IF
     END IF

  2. SellIn減少（フェーズ2）
     sellIn = sellIn - 1

  3. コンサート終了後のQuality初期化（フェーズ3）
     IF sellIn < 0 THEN
       quality = 0
     END IF
```

## 次フェーズへの引き継ぎ事項

### フェーズ2（振る舞いの形式化）に向けて

以下のテストパターンを網羅すること：

1. **基本パターン**:
   - 11日以上前での+1増加
   - 10日以内での+2増加
   - 5日以内での+3増加
   - コンサート終了後のquality = 0

2. **境界値パターン**:
   - sellIn = 11 → 10（+1から+2への遷移）
   - sellIn = 6 → 5（+2から+3への遷移）
   - sellIn = 1 → 0（+3からquality = 0への遷移）
   - sellIn = 0 → -1（コンサート当日から終了後への遷移）
   - quality = 48, 49, 50（上限周辺）

3. **エッジケース**:
   - sellIn = 10, quality = 49 の場合（+1のみ、上限で停止）
   - sellIn = 3, quality = 48 の場合（+2のみ、+3にならず上限で停止）
   - sellIn = 0 での処理（増加後に0に初期化）
   - 初期状態が quality = 50 の場合
   - 負のsellInでの連続処理（常にquality = 0）

### 状態遷移図で表現すべき状態

- **11日以上前状態**（sellIn >= 11）: +1/日
- **10日以内状態**（6 <= sellIn <= 10）: +2/日
- **5日以内状態**（1 <= sellIn <= 5）: +3/日
- **コンサート当日状態**（sellIn = 0）: 終了扱い
- **コンサート終了後状態**（sellIn < 0）: quality = 0
- **上限到達状態**（quality = 50）: 増加停止

### 注意点

- Quality上限チェックは、各増加ステップの前に個別に実行される
- sellInの減少はQuality増加の後で実行される（フェーズ2）
- コンサート終了判定（sellIn < 0）は、sellIn減少後に評価される
- sellIn = 0 では、フェーズ1の増加が適用された後、フェーズ3でquality = 0に上書きされる

## 参照

- 詳細な分析プロセス: `analysis.md`
- 元の要件文: `GildedRoseRequirements_jp.md`
- 実装コード: `Java/src/main/java/com/gildedrose/GildedRose.java:10-61`
- Aged Brieの仕様: `docs/requirements/aged-brie/final-analysis.md`
- 通常アイテムの仕様: `docs/requirements/normal-item/final-analysis.md`
