# Backstage passes to a TAFKAL80ETC concert 要件分析

このドキュメントは、Backstage passesアイテムタイプの要件を段階的に分析するプロセスを記録します。

## 1. 要件抽出

### 1.1 元の要件文（GildedRoseRequirements_jp.mdより）

**Backstage passes固有の要件**:
> "Backstage passes"は、"Aged Brie"と同様、SellIn値が近づくにつれてQuality値が上昇し、10日以内になると毎日2上がり、5日以内になると毎日3上がりますが、コンサート終了後には0になります。

**共通要件（Backstage passesにも適用）**:
- すべてのアイテムには、アイテムを販売するための残り日数（販売期限）を示すSellIn値があります。
- 毎日の終わりには、私たちのシステムは、両方の項目の値を1小さくします。
- Quality値は決してマイナスにはなりません。
- Quality値は50以上にはなりません。

### 1.2 抽出した要件ルール

#### R1: SellInの減少（共通ルール）
- 毎日の終わりにSellIn値が1減少する
- 全アイテム共通の振る舞い

#### R2: Qualityの増加（Backstage passes固有）
- SellIn値が近づくにつれてQuality値が上昇する
- Aged Brieと類似するが、増加速度が販売期限によって変化する

#### R3: 10日以内の増加速度（Backstage passes固有）
- 10日以内になると毎日2上がる
- 通常より増加速度が速くなる

#### R4: 5日以内の増加速度（Backstage passes固有）
- 5日以内になると毎日3上がる
- さらに増加速度が速くなる

#### R5: コンサート終了後のQuality（Backstage passes固有）
- コンサート終了後にはQualityが0になる
- 他のアイテムにはない特殊な振る舞い

#### R6: Qualityの上限（共通ルール）
- Quality値は50を超えない
- Quality値が50の場合、それ以上増加しない

#### R7: Qualityの下限（共通ルール）
- Quality値は0未満にならない
- コンサート終了後に0になる場合も、このルールに従う

### 1.3 不明確な点・要検証事項

1. **基本増加量**:
   - 質問1: 「10日以内で毎日2上がる」「5日以内で毎日3上がる」とあるが、それ以上の日数（例：11日以上）の場合の増加量は？
     - 可能性1: 増加しない（0/日）
     - 可能性2: 基本増加量がある（例：+1/日）

2. **境界値の解釈**:
   - 質問2: 「10日以内」とは sellIn < 11 か sellIn <= 10 か？
   - 質問3: 「5日以内」とは sellIn < 6 か sellIn <= 5 か？
   - 質問4: sellIn = 10 の場合、+2/日か、それとも別の増加量か？
   - 質問5: sellIn = 5 の場合、+3/日か、それとも別の増加量か？

3. **コンサート終了後の定義**:
   - 質問6: 「コンサート終了後」とは sellIn < 0 か sellIn <= 0 か？
   - 質問7: sellIn = 0 は「コンサート当日」か「コンサート終了後」か？

4. **増加量の計算方法**:
   - 質問8: 「5日以内で毎日3上がる」は以下のどちらか？
     - 解釈A: 基本+1、10日以内ボーナス+1、5日以内ボーナス+1の合計+3
     - 解釈B: 段階的に増加量が変わり、5日以内では一律+3

5. **上限到達時の振る舞い**:
   - 質問9: Quality=50の場合、増加処理は試みられるが50で維持されるか
   - 質問10: Quality=48でsellIn=3の場合、+3で51になるか、50で止まるか？

6. **コンサート終了後のQuality変化**:
   - 質問11: 「コンサート終了後には0になる」とは、即座に0になるのか、それとも徐々に減少するのか？
   - 質問12: Quality=10でコンサート終了（sellIn < 0）になった場合、次の日のQualityは0か？

### 1.4 次のステップ

ステップ1-2で既存コードを分析し、上記の不明確な点を解消する。

---

## 2. コード分析

### 2.1 関連コード抽出（GildedRose.java:10-61より）

Backstage passesの処理に関連する部分を抽出：

#### フェーズ1: 販売期限前の品質更新（12-37行目）

```java
if (!items[i].name.equals("Aged Brie")
        && !items[i].name.equals("Backstage passes to a TAFKAL80ETC concert")) {
    // 通常アイテムの劣化処理（Backstage passesは除外）
    if (items[i].quality > 0) {
        if (!items[i].name.equals("Sulfuras, Hand of Ragnaros")) {
            items[i].quality = items[i].quality - 1;
        }
    }
} else {
    // Aged Brie または Backstage passes の処理
    if (items[i].quality < 50) {
        items[i].quality = items[i].quality + 1;  // ← 基本増加: +1

        if (items[i].name.equals("Backstage passes to a TAFKAL80ETC concert")) {
            // Backstage passes 固有の処理
            if (items[i].sellIn < 11) {
                if (items[i].quality < 50) {
                    items[i].quality = items[i].quality + 1;  // ← 10日以内ボーナス: +1
                }
            }

            if (items[i].sellIn < 6) {
                if (items[i].quality < 50) {
                    items[i].quality = items[i].quality + 1;  // ← 5日以内ボーナス: +1
                }
            }
        }
    }
}
```

#### フェーズ2: SellInの減少（39-41行目）

```java
if (!items[i].name.equals("Sulfuras, Hand of Ragnaros")) {
    items[i].sellIn = items[i].sellIn - 1;  // ← Backstage passesもsellInが-1
}
```

#### フェーズ3: 販売期限切れ後の追加処理（43-59行目）

```java
if (items[i].sellIn < 0) {
    if (!items[i].name.equals("Aged Brie")) {
        if (!items[i].name.equals("Backstage passes to a TAFKAL80ETC concert")) {
            // 通常アイテムの処理（Backstage passesは除外）
            if (items[i].quality > 0) {
                if (!items[i].name.equals("Sulfuras, Hand of Ragnaros")) {
                    items[i].quality = items[i].quality - 1;
                }
            }
        } else {
            // Backstage passesの場合
            items[i].quality = items[i].quality - items[i].quality;  // ← quality = 0
        }
    } else {
        // Aged Brieの処理
        // ...
    }
}
```

### 2.2 コードから読み取れる振る舞い

#### 処理の流れ

1. **フェーズ1**: 販売期限に関わらず、以下の処理を実行
   - 基本増加: quality < 50 なら quality を +1（GildedRose.java:21）
   - 10日以内ボーナス: sellIn < 11 かつ quality < 50 なら quality を +1（GildedRose.java:26）
   - 5日以内ボーナス: sellIn < 6 かつ quality < 50 なら quality を +1（GildedRose.java:32）

2. **フェーズ2**: sellInを-1（GildedRose.java:40）

3. **フェーズ3**: sellIn < 0（コンサート終了後）の場合、quality = 0に設定（GildedRose.java:52）

#### 販売期限による増加速度の違い

**コンサート終了後（sellIn < 0）**:
- フェーズ1は実行されるが、フェーズ3でquality = 0に上書きされる
- **結果: quality = 0（増加量は無視される）**

**コンサート当日（sellIn = 0）**:
- フェーズ1で基本+1（sellIn < 11を満たすので+1、sellIn < 6を満たさないので追加なし）= 合計+2
- フェーズ2でsellInが-1されて、sellIn = -1になる
- フェーズ3の条件（sellIn < 0）を満たし、quality = 0に設定
- **結果: quality = 0（増加は適用されない）**

**1〜5日前（1 <= sellIn <= 5）**:
- フェーズ1で基本+1、10日以内ボーナス+1、5日以内ボーナス+1
- フェーズ3は実行されない（sellIn < 0の条件を満たさない）
- **合計: +3/日**

**6〜10日前（6 <= sellIn <= 10）**:
- フェーズ1で基本+1、10日以内ボーナス+1
- フェーズ3は実行されない
- **合計: +2/日**

**11日以上前（sellIn >= 11）**:
- フェーズ1で基本+1のみ
- フェーズ3は実行されない
- **合計: +1/日**

#### Quality上限の制御

- 各増加処理の前に `quality < 50` をチェック
- Quality = 50に到達すると、それ以上増加しない
- 上限チェックは増加前に行われる（GildedRose.java:20, 25, 31）
- 例: quality = 48、sellIn = 3 の場合
  - 基本+1 → quality = 49
  - 10日以内ボーナス+1 → quality = 50
  - 5日以内ボーナス: quality < 50 の条件を満たさないため、追加されない
  - **結果: quality = 50（51にはならない）**

### 2.3 不明確だった点の解消

ステップ1-1で挙げた不明確な点について、コード分析により以下が判明：

1. **基本増加量**:
   - ✅ 解決: 11日以上前でも基本増加量 +1/日がある
   - 可能性2が正解: 基本増加量がある（+1/日）

2. **境界値の解釈**:
   - ✅ 解決:
     - 「10日以内」は `sellIn < 11` （sellIn <= 10 と同義）
     - 「5日以内」は `sellIn < 6` （sellIn <= 5 と同義）
   - ✅ 解決: sellIn = 10 の場合、基本+1 + 10日以内ボーナス+1 = +2/日
   - ✅ 解決: sellIn = 5 の場合、基本+1 + 10日以内ボーナス+1 + 5日以内ボーナス+1 = +3/日

3. **コンサート終了後の定義**:
   - ✅ 解決: 「コンサート終了後」は `sellIn < 0`
   - ✅ 解決: sellIn = 0 は「コンサート当日」だが、処理の結果quality = 0になる
     - sellInが-1された後にsellIn < 0の判定が行われるため、当日でもquality = 0になる

4. **増加量の計算方法**:
   - ✅ 解決: 解釈Aが正解
     - 基本+1、10日以内ボーナス+1、5日以内ボーナス+1の累積加算
     - sellIn値によって適用されるボーナスが変わる

5. **上限到達時の振る舞い**:
   - ✅ 解決: quality = 50 の場合、増加処理は試みられず50で維持される
   - ✅ 解決: quality = 48、sellIn = 3 の場合、+2増加して50で止まる（51にはならない）
     - 各増加ステップで `quality < 50` をチェックするため

6. **コンサート終了後のQuality変化**:
   - ✅ 解決: 即座に0になる（徐々にではない）
   - ✅ 解決: quality = 10、sellIn < 0 の場合、次の日のquality = 0
     - `quality = quality - quality` により、どんな値でも0になる

### 2.4 抽出したコードルール

#### C1: 基本Quality増加
- **条件**: quality < 50
- **処理**: quality を +1
- **実装箇所**: GildedRose.java:20-21
- **適用範囲**: すべてのsellIn値（sellIn < 0 でも一旦は実行される）

#### C2: 10日以内ボーナス
- **条件**: sellIn < 11 かつ quality < 50
- **処理**: quality を +1
- **実装箇所**: GildedRose.java:24-28
- **適用範囲**: sellIn <= 10

#### C3: 5日以内ボーナス
- **条件**: sellIn < 6 かつ quality < 50
- **処理**: quality を +1
- **実装箇所**: GildedRose.java:30-34
- **適用範囲**: sellIn <= 5

#### C4: SellInの減少
- **条件**: Sulfurasでない
- **処理**: sellIn を -1
- **実装箇所**: GildedRose.java:39-40

#### C5: コンサート終了後のQuality初期化
- **条件**: sellIn < 0
- **処理**: quality = 0 に設定
- **実装箇所**: GildedRose.java:51-52
- **備考**: フェーズ1で増加した値を上書き

#### C6: Quality上限の制御
- **条件**: quality < 50
- **結果**: Quality は最大50まで
- **実装箇所**: GildedRose.java:20, 25, 31（各増加処理の条件）
- **備考**: 各増加ステップで個別にチェック

### 2.5 境界条件の整理

| 初期状態 | sellIn | quality | 1日後 sellIn | 1日後 quality | 増加内訳 | 備考 |
|---------|--------|---------|-------------|--------------|---------|------|
| 11日以上前 | 15 | 10 | 14 | 11 | 基本+1 | |
| 10日前（境界） | 10 | 10 | 9 | 12 | 基本+1, 10日以内+1 | |
| 6〜10日前 | 7 | 10 | 6 | 12 | 基本+1, 10日以内+1 | |
| 5日前（境界） | 5 | 10 | 4 | 13 | 基本+1, 10日以内+1, 5日以内+1 | |
| 1〜5日前 | 3 | 10 | 2 | 13 | 基本+1, 10日以内+1, 5日以内+1 | |
| 1日前 | 1 | 10 | 0 | 13 | 基本+1, 10日以内+1, 5日以内+1 | |
| 当日（境界） | 0 | 10 | -1 | 0 | コンサート終了 | sellIn-1後に判定 |
| 終了後 | -1 | 10 | -2 | 0 | コンサート終了 | 増加は上書き |
| 上限到達 | 10 | 50 | 9 | 50 | 増加しない | |
| 上限直前 | 10 | 49 | 9 | 50 | 基本+1のみ | ボーナス適用されず |
| 上限直前2 | 15 | 49 | 14 | 50 | 基本+1 | |
| 上限2未満 | 3 | 48 | 2 | 50 | 基本+1, 10日以内+1 | 5日以内は適用されず |

### 2.6 次のステップ

ステップ1-3で、要件文とコードの振る舞いの差分を確認する。

---

## 3. 差分分析

### 3.1 要件とコードの対応表

| 要件ID | 要件文の内容 | コードの実装 | 一致 | 備考 |
|-------|-------------|------------|------|------|
| R1 | SellInが毎日1減少 | C4: sellIn を -1 | ✅ | 完全一致 |
| R2 | SellIn値が近づくにつれてQualityが上昇 | C1: 基本+1<br>C2: 10日以内ボーナス+1<br>C3: 5日以内ボーナス+1 | ✅ | 完全一致（詳細後述） |
| R3 | 10日以内で毎日2上がる | C1 + C2: 基本+1 + ボーナス+1 = +2 | ✅ | 完全一致 |
| R4 | 5日以内で毎日3上がる | C1 + C2 + C3: 基本+1 + 10日以内+1 + 5日以内+1 = +3 | ✅ | 完全一致 |
| R5 | コンサート終了後にQuality = 0 | C5: sellIn < 0 で quality = 0 | ✅ | 完全一致 |
| R6 | Quality上限50 | C6: quality < 50 で増加制御 | ✅ | 完全一致 |
| R7 | Quality下限0 | C5で0に設定 | ✅ | コンサート終了後に適用 |

### 3.2 発見された差分

#### 差分1: 11日以上前の増加量

**要件文**:
> "Backstage passes"は、"Aged Brie"と同様、SellIn値が近づくにつれてQuality値が上昇し、10日以内になると毎日2上がり、5日以内になると毎日3上がりますが、コンサート終了後には0になります。

- 「10日以内で毎日2上がる」「5日以内で毎日3上がる」の記述のみ
- 11日以上前（sellIn >= 11）の増加量について明示的な記述なし

**コードの実装**:
- 11日以上前（sellIn >= 11）: 基本+1/日
- 6〜10日前（6 <= sellIn <= 10）: +2/日
- 1〜5日前（1 <= sellIn <= 5）: +3/日

**分析**:
- 要件文には11日以上前の振る舞いが明記されていない
- コードでは基本増加量（+1/日）が実装されている
- これは「SellIn値が近づくにつれてQuality値が上昇」を実現するための基本実装

**解釈の選択肢**:
1. **コードを正とする**: 11日以上前でも+1/日で増加。要件文が簡略化されただけ
2. **要件を正とする**: 11日以上前は増加しない（+0/日）。コードが誤実装

#### 差分2: sellIn = 0 の扱い

**要件文**:
- 「コンサート終了後には0になる」とあるが、sellIn = 0 が「終了後」か「当日」かは不明確

**コードの実装**:
- sellIn = 0 の場合、sellInを-1してから sellIn < 0 の判定を行うため、quality = 0 になる
- 実質的に sellIn = 0 は「コンサート終了」として扱われる

**分析**:
- 通常アイテムやAged Brieでは、sellIn = 0 は「期限当日」で期限切れ扱い
- Backstage passesも同様に、sellIn = 0 を期限切れ（コンサート終了）として扱う
- 一貫性のある設計

### 3.3 差分の評価

#### 11日以上前の基本増加量について

**Aged Brieとの比較**:

要件文には以下の記述がある：
> "Backstage passes"は、"Aged Brie"と同様、SellIn値が近づくにつれてQuality値が上昇し

**Aged Brieの振る舞い**（`docs/requirements/aged-brie/final-analysis.md`参照）:
- 販売期限内: +1/日
- 販売期限切れ: +2/日

**Backstage passesの類推**:
- 「Aged Brieと同様」という記述から、基本的な増加パターンはAged Brieを踏襲すると推測できる
- Aged Brieが常に増加するように、Backstage passesも常に増加すると考えられる
- 11日以上前で+1/日という基本増加量は、この「同様」に該当する

**コードの一貫性**:
- 基本増加（C1）は、Aged BrieとBackstage passesで共通のコードブロック（GildedRose.java:19-21）
- 10日以内、5日以内のボーナスは、Backstage passes固有の追加処理
- 基本+1の上にボーナスを積み重ねる構造は、理解しやすく一貫している

#### sellIn = 0 の扱いについて

**他アイテムとの一貫性**:

通常アイテムとAged Brieの分析結果から：
- sellIn = 0 は「販売期限当日」であり、期限切れ扱いが適用される
- コードでは、sellInを-1してから期限切れ判定（sellIn < 0）を行う構造

Backstage passesも同様に：
- sellIn = 0 は「コンサート当日」だが、コンサート終了として扱われる
- 実装の一貫性が保たれている

**ビジネスロジックの妥当性**:
- コンサートは1日の中で終了するため、当日の終わりにはチケットの価値が0になる
- sellIn = 0 を「コンサート終了」として扱うのは妥当

### 3.4 推奨される解釈

**結論**: コードの実装を「正」とし、以下の仕様を採用する

**採用する仕様**:
1. **11日以上前（sellIn >= 11）**: +1/日（基本増加）
2. **6〜10日前（6 <= sellIn <= 10）**: +2/日（基本+1 + 10日以内ボーナス+1）
3. **1〜5日前（1 <= sellIn <= 5）**: +3/日（基本+1 + 10日以内+1 + 5日以内+1）
4. **コンサート当日・終了後（sellIn <= 0）**: quality = 0
5. **Quality上限**: 50
6. **Quality下限**: 0

**理由**:
1. **Aged Brieとの対称性**: 「Aged Brieと同様」という記述から、基本増加量を持つのは自然
2. **コードの一貫性**: 基本増加 + ボーナスという構造が明確
3. **sellIn = 0 の扱い**: 他アイテムとの一貫性が保たれている
4. **ビジネスロジックの妥当性**: コンサートに近づくほど価値が上がり、終了後は価値がなくなる
5. **要件文の解釈**: 要件文は主要な振る舞い（10日以内、5日以内、終了後）を強調し、基本増加は省略したと解釈できる

**確定仕様として記載すべき内容**:
- Backstage passesはコンサートに近づくほどQualityが上昇する
- 基本増加: +1/日（11日以上前）
- 10日以内（sellIn <= 10）: +2/日
- 5日以内（sellIn <= 5）: +3/日
- コンサート終了後（sellIn <= 0）: quality = 0
- Quality上限は50、下限は0

### 3.5 その他の確認事項

#### sellIn = 0 の処理順序

コードの処理順序を再確認：
1. フェーズ1: 基本増加 + ボーナス（sellIn = 0 では基本+1 + 10日以内+1 = +2）
2. フェーズ2: sellIn を -1（sellIn = -1 になる）
3. フェーズ3: sellIn < 0 の判定に該当し、quality = 0 に設定

→ sellIn = 0 では、フェーズ1の増加は適用されず、結果的に quality = 0 になる

#### 境界値の網羅性

表2.5で示した境界条件は、以下を網羅：
- sellIn の境界値: 11, 10, 6, 5, 1, 0, -1
- quality の境界値: 50, 49, 48（上限周辺）
- 各パターンの増加内訳と結果

### 3.6 人間レビュー結果

以下の点について、人間レビューで確認した結果：

1. **11日以上前の基本増加量（+1/日）を正式仕様とするか**:
   - [x] コードを正とし、基本増加+1/日を採用 ← **採用**
   - [ ] 要件を正とし、11日以上前は+0/日に修正

2. **sellIn = 0 の扱い**:
   - [x] コンサート終了扱い（quality = 0）- コードの実装通り ← **採用**
   - [ ] コンサート当日扱い（+2増加）- 別の解釈

3. **増加量の内訳表現**:
   - [ ] 「基本+1 + ボーナス」という内訳を仕様書に明記する
   - [x] 結果の増加量（+1, +2, +3）のみを仕様書に記載する ← **採用**

**決定事項**:
- コードの実装を正式仕様として採用する
- 11日以上前でも+1/日で増加（「Aged Brieと同様」の解釈）
- sellIn = 0 はコンサート終了扱い（他アイテムとの一貫性を重視）
- 仕様書では観察可能な結果（+1, +2, +3/日、quality = 0）を記載し、内部実装の詳細はコード分析資料に残す

### 3.7 次のステップ

- 人間レビューで判断を確定
- ステップ1-4で確定仕様を作成
