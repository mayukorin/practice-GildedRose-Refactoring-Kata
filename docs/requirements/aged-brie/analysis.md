# Aged Brie 要件分析

このドキュメントは、Aged Brieアイテムタイプの要件を段階的に分析するプロセスを記録します。

## 1. 要件抽出

### 1.1 元の要件文（GildedRoseRequirements_jp.mdより）

**Aged Brie固有の要件**:
> "Aged Brie"は、日が経つほどQuality値が上がっていきます。

**共通要件（Aged Brieにも適用）**:
- すべてのアイテムには、アイテムを販売するための残り日数（販売期限）を示すSellIn値があります。
- 毎日の終わりには、私たちのシステムは、両方の項目の値を1小さくします。
- Quality値は決してマイナスにはなりません。
- Quality値は50以上にはなりません。

### 1.2 抽出した要件ルール

#### R1: SellInの減少（共通ルール）
- 毎日の終わりにSellIn値が1減少する
- 全アイテム共通の振る舞い

#### R2: Qualityの増加（Aged Brie固有）
- 日が経つごとにQuality値が上がる
- 通常アイテムとは逆の振る舞い

#### R3: Qualityの上限（共通ルール）
- Quality値は50を超えない
- Quality値が50の場合、それ以上増加しない

#### R4: Qualityの下限（共通ルール）
- Quality値は0未満にならない
- ただし、Aged BrieはQualityが増加するため、このルールが適用される場面は限定的

### 1.3 不明確な点・要検証事項

1. **増加速度**: 「日が経つほど」という表現から、増加量は以下のどちらか？
   - 解釈A: 毎日一定量（例：+1）増加する
   - 解釈B: 経過日数に応じて増加量が変わる

2. **販売期限との関係**:
   - 質問1: 販売期限切れ（sellIn ≤ 0）でも増加速度は同じか？
   - 質問2: 通常アイテムは「販売期限が過ぎるとQualityが2倍速で劣化」するが、Aged Brieにも類似のルールがあるか？
     - 可能性1: 販売期限内は+1、期限切れ後は+2
     - 可能性2: 常に+1（販売期限の影響を受けない）

3. **上限到達時の振る舞い**:
   - Quality=50の場合、増加処理は試みられるが50で維持されるか
   - 上限チェックのタイミング（増加前 or 増加後）

### 1.4 次のステップ

ステップ1-2で既存コードを分析し、上記の不明確な点を解消する。

---

## 2. コード分析

### 2.1 関連コード抽出（GildedRose.java:10-61より）

Aged Brieの処理に関連する部分を抽出：

#### フェーズ1: 販売期限前の品質更新（12-37行目）

```java
if (!items[i].name.equals("Aged Brie")
        && !items[i].name.equals("Backstage passes to a TAFKAL80ETC concert")) {
    // 通常アイテムの劣化処理（Aged Brieは除外）
    if (items[i].quality > 0) {
        if (!items[i].name.equals("Sulfuras, Hand of Ragnaros")) {
            items[i].quality = items[i].quality - 1;
        }
    }
} else {
    // Aged Brie または Backstage passes の処理
    if (items[i].quality < 50) {
        items[i].quality = items[i].quality + 1;  // ← Aged Brieはここで+1

        // Backstage passesの追加処理（Aged Brieには無関係）
        // ...
    }
}
```

#### フェーズ2: SellInの減少（39-41行目）

```java
if (!items[i].name.equals("Sulfuras, Hand of Ragnaros")) {
    items[i].sellIn = items[i].sellIn - 1;  // ← Aged BrieもsellInが-1
}
```

#### フェーズ3: 販売期限切れ後の追加処理（43-59行目）

```java
if (items[i].sellIn < 0) {
    if (!items[i].name.equals("Aged Brie")) {
        // 通常アイテムとBackstage passesの処理（Aged Brieは除外）
        // ...
    } else {
        // Aged Brieの場合
        if (items[i].quality < 50) {
            items[i].quality = items[i].quality + 1;  // ← さらに+1
        }
    }
}
```

### 2.2 コードから読み取れる振る舞い

#### 処理の流れ
1. **フェーズ1**: 販売期限に関わらず、quality < 50 なら quality を +1（GildedRose.java:20-21）
2. **フェーズ2**: sellInを-1（GildedRose.java:40）
3. **フェーズ3**: sellIn < 0（販売期限切れ）の場合、quality < 50 なら さらに quality を +1（GildedRose.java:55-56）

#### 販売期限による増加速度の違い

**販売期限内（sellIn > 0）**:
- フェーズ1で+1
- フェーズ3は実行されない（sellIn < 0の条件を満たさない）
- **合計: +1/日**

**販売期限当日（sellIn = 0）**:
- フェーズ1で+1
- フェーズ2でsellInが-1されて、sellIn = -1になる
- フェーズ3の条件（sellIn < 0）を満たし、さらに+1
- **合計: +2/日**

**販売期限切れ後（sellIn < 0）**:
- フェーズ1で+1
- フェーズ2でsellInがさらに-1
- フェーズ3の条件（sellIn < 0）を満たし、さらに+1
- **合計: +2/日**

#### Quality上限の制御
- 各増加処理の前に `quality < 50` をチェック
- Quality = 50に到達すると、それ以上増加しない
- 上限チェックは増加前に行われる（GildedRose.java:20, 55）

### 2.3 不明確だった点の解消

ステップ1-1で挙げた不明確な点について、コード分析により以下が判明：

1. **増加速度**:
   - ✅ 解決: 毎日+1（販売期限内）
   - コードでは `quality = quality + 1` が実行される

2. **販売期限との関係**:
   - ✅ 解決: 販売期限切れ（sellIn < 0）では2倍速で増加（+2/日）
   - 通常アイテムの「期限切れで2倍速劣化」と同じパターン
   - 販売期限内: +1/日、期限切れ: +2/日

3. **上限到達時の振る舞い**:
   - ✅ 解決: quality < 50 の条件チェックにより、50で増加が止まる
   - 増加処理は試みられず、50で維持される

### 2.4 抽出したコードルール

#### C1: 販売期限内のQuality増加
- **条件**: quality < 50
- **処理**: quality を +1
- **実装箇所**: GildedRose.java:20-21

#### C2: SellInの減少
- **条件**: Sulfurasでない
- **処理**: sellIn を -1
- **実装箇所**: GildedRose.java:40

#### C3: 販売期限切れ後の追加Quality増加
- **条件**: sellIn < 0 かつ quality < 50
- **処理**: quality をさらに +1
- **実装箇所**: GildedRose.java:55-56

#### C4: Quality上限の制御
- **条件**: quality < 50
- **結果**: Quality は最大50まで
- **実装箇所**: GildedRose.java:20, 55（増加処理の条件）

### 2.5 境界条件の整理

| 初期状態 | sellIn | quality | 1日後 sellIn | 1日後 quality | 備考 |
|---------|--------|---------|-------------|--------------|------|
| 期限内 | 3 | 10 | 2 | 11 | +1増加 |
| 期限当日 | 0 | 10 | -1 | 12 | +2増加（期限切れ扱い） |
| 期限切れ | -1 | 10 | -2 | 12 | +2増加 |
| 上限到達 | 3 | 50 | 2 | 50 | 増加しない |
| 上限直前（期限内） | 3 | 49 | 2 | 50 | +1で上限 |
| 上限直前（期限切れ） | -1 | 49 | -2 | 50 | +1のみ（+2にならず50で止まる） |

### 2.6 次のステップ

ステップ1-3で、要件文とコードの振る舞いの差分を確認する。

---

## 3. 差分分析

### 3.1 要件とコードの対応表

| 要件ID | 要件文の内容 | コードの実装 | 一致 | 備考 |
|-------|-------------|------------|------|------|
| R1 | SellInが毎日1減少 | C2: sellIn を -1 | ✅ | 完全一致 |
| R2 | 日が経つほどQualityが上がる | C1: quality を +1<br>C3: 期限切れでさらに+1 | ⚠️ | 部分的に一致（詳細後述） |
| R3 | Quality上限50 | C4: quality < 50 で増加制御 | ✅ | 完全一致 |
| R4 | Quality下限0 | （該当なし） | - | Aged Brieは増加するため未使用 |

### 3.2 発見された差分

#### 差分1: 販売期限切れ後の増加速度

**要件文**:
> "Aged Brie"は、日が経つほどQuality値が上がっていきます。

- 「日が経つほど」という表現のみ
- 販売期限との関係について明示的な記述なし

**コードの実装**:
- 販売期限内: +1/日
- 販売期限切れ（sellIn < 0）: +2/日

**分析**:
- 要件文には「期限切れで2倍速」という記述がない
- しかし、コードでは期限切れ後に2倍速で増加する実装
- これは通常アイテムの「販売期限が過ぎるとQualityが2倍速で劣化」と対称的なパターン

**解釈の選択肢**:
1. **コードを正とする**: 通常アイテムと対称的な設計として妥当。要件文が簡略化されただけ
2. **要件を正とする**: 期限に関わらず一定速度（+1/日）で増加すべき。コードが誤実装

### 3.3 差分の評価

#### 通常アイテムとの対称性

通常アイテムの要件とコードを参照すると：

**通常アイテムの要件文**（GildedRoseRequirements_jp.md）:
- 基本: Quality が毎日1減少
- 期限切れ: Quality が毎日2減少（「2倍速で劣化」）

**Aged Brieの類推**:
- 基本: Quality が毎日1増加
- 期限切れ: Quality が毎日2増加（「2倍速で向上」？）

コードの実装は、通常アイテムと対称的なパターンを踏襲している。

#### 暗黙の仕様の可能性

要件文には明示されていないが、以下の理由から「期限切れで2倍速増加」は暗黙の仕様と考えられる：

1. **通常アイテムとの一貫性**:
   - 通常アイテム: 期限切れで劣化速度2倍
   - Aged Brie: 期限切れで向上速度2倍（対称的）

2. **コードの意図**:
   - フェーズ3の処理（GildedRose.java:54-58）はAged Brie専用の分岐
   - 意図的に追加の+1を実装している

3. **ビジネスロジックの妥当性**:
   - チーズは熟成が進むほど価値が上がる
   - 販売期限を過ぎた古いチーズは、さらに熟成が進み価値が高まる可能性がある

### 3.4 推奨される解釈

**結論**: コードの実装を「正」とし、販売期限切れ後は+2/日とする

**理由**:
1. 通常アイテムとの対称性が保たれる
2. コードの実装が明確に意図を持っている
3. ビジネスロジックとして矛盾しない
4. 要件文は簡略化された記述と解釈できる

**確定仕様として記載すべき内容**:
- Aged Brieは日が経つほどQualityが上がる
- 販売期限内: +1/日
- 販売期限切れ（sellIn < 0）: +2/日
- Quality上限は50

### 3.5 その他の確認事項

#### sellIn = 0 の扱い

- 通常アイテムの分析（`docs/requirements/normal-item/final-analysis.md`）と同様
- sellIn = 0 は「販売期限当日」であり、期限切れ扱い（sellIn < 0）が適用される
- コードでは、sellInを-1してから期限切れ判定を行うため、sellIn=0でも+2増加

#### 境界値の確認

表2.5で示した境界条件は、以下を網羅：
- 期限内、期限当日、期限切れの各パターン
- Quality上限到達、上限直前のパターン
- 上限到達時の増加制限の動作

### 3.6 人間レビュー結果

以下の点について、人間レビューで確認した結果：

1. **販売期限切れ後の+2増加を正式仕様とするか**:
   - [x] コードを正とし、期限切れ後+2/日を採用 ← **採用**
   - [ ] 要件を正とし、常に+1/日に修正

2. **sellIn = 0 の扱い**:
   - [x] 期限切れ扱い（+2増加）- コードの実装通り ← **採用**
   - [ ] 期限内扱い（+1増加）- 別の解釈

**決定事項**:
- コードの実装を正式仕様として採用する
- 通常アイテムとの対称性を重視した設計を維持する
- sellIn = 0 は期限切れ扱いとする（通常アイテムと同じ解釈）

### 3.7 次のステップ

- ✅ 人間レビューで判断を確定
- ステップ1-4で確定仕様を作成
